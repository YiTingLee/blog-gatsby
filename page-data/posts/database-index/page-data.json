{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/database-index","result":{"data":{"markdownRemark":{"id":"af4cc287-2874-5090-8e6a-b2a8e9248bd1","html":"<h2 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>此文章的目的並非讓大家對於Btree有深度了解，而是使用簡單的方式解釋Database Index的基本原理，使得在設計Index的時候有正確的方向。</p>\n<h2 id=\"介紹\" style=\"position:relative;\"><a href=\"#%E4%BB%8B%E7%B4%B9\" aria-label=\"介紹 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>介紹</h2>\n<p>當我們發現資料庫Query速度越來越慢，且已經漸漸地影響到使用者體驗的時候，那就是優化資料庫的最佳時機，而最典型的方法就是加index，但是在設計上如果不理解index的原理而隨便亂加的話，反而會造成整體資料庫效率降低!!</p>\n<p>目前多數的RDBMS的index都是由Btree的方法實作，所以講Database index之前，必須先簡單了解一下Btree的基本特性。</p>\n<h2 id=\"btree\" style=\"position:relative;\"><a href=\"#btree\" aria-label=\"btree permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Btree</h2>\n<p>這是Btree的基本樣貌:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 581px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b0d23b6403235a016886f015fa36c24/92d15/btree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABiElEQVQoz4VSy2rCUBC9adOH0FVbiYK0bvsF3Urpp3SRLxJcFZTsuhYEKwohKGrwiYIgRI1PxFfSBEIyPbeQTbvowMBlMufMmTNh7FcoisJkWf55D4dD43Q60WQy8efzubfb7ajVaimNRoPV6/WzYrHI/g0iCp/Xuq6bvu/TaDSi5XIZ2LZN5XL5g/fwTKfTfwnG47FgWZZQKBQE3pTNZs9EUYxIknQJomfDMFKqqr5CWWo6nb4MBoMnwC6SyWQkJK5UKoLneQIUC5yQbTYbXgzVieEwXgcBC4EgZ1g//Cwgz3m9Vquxw+HAMJgx0zSjAN5Xq9V4JpN5WK1WEpqueON6vb6Fb7FSqZRAcwJ9MdTugiDgA25AFM/lco+dTkc6Ho9RWBTlCh144+AALqbYMJ8AfsOKrN1uf+73e5rNZjaUfQFEAGtcabPZfN9ut9xbC9a4WNnJ5/MOgy+EiQRicl03gArSNE3udrus1+upqBFUBzwBon6/ry8WC8avzf8AbOBjAPHAHegbxL5QhdldE2wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3b0d23b6403235a016886f015fa36c24/8ac56/btree.webp 240w,\n/static/3b0d23b6403235a016886f015fa36c24/d3be9/btree.webp 480w,\n/static/3b0d23b6403235a016886f015fa36c24/39daa/btree.webp 581w\"\n              sizes=\"(max-width: 581px) 100vw, 581px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3b0d23b6403235a016886f015fa36c24/8ff5a/btree.png 240w,\n/static/3b0d23b6403235a016886f015fa36c24/e85cb/btree.png 480w,\n/static/3b0d23b6403235a016886f015fa36c24/92d15/btree.png 581w\"\n            sizes=\"(max-width: 581px) 100vw, 581px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3b0d23b6403235a016886f015fa36c24/92d15/btree.png\"\n            alt=\"Btree\"\n            title=\"Btree\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Btree共有幾種特性:</p>\n<ul>\n<li>有別於一般二元樹，每個node都能擁有多個Key</li>\n<li>一個node可以擁有K+1個支線(K = Key的數量)</li>\n<li>Key數值必在兩個Parent的Key範圍內(如圖上的56/74都在47及99內)</li>\n<li>Btree為平衡樹且每個葉節點深度必定相同</li>\n</ul>\n<p>接著我們來看一下Search速度上的差異，圖上的例子共有23/44/47等八個數字，若我們用For-loop的方式尋找，最差情況是O(n)</p>\n<p>若我們從Btree的方式搜尋，則最差情況是最深階層數，故為O(log n)</p>\n<h2 id=\"database-index\" style=\"position:relative;\"><a href=\"#database-index\" aria-label=\"database index permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Database index</h2>\n<p>其實在使用資料庫的同時，我們已經不知不覺中使用了大量的index，而這個index就是每個Table的Primary Key，接下來我們就用PK來解釋Database的搜尋方式</p>\n<p>首先我們先建立簡單的Table</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> test<span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">integer</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span><span class=\"token punctuation\">,</span>\n    num <span class=\"token keyword\">integer</span><span class=\"token punctuation\">,</span>\n    content <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>找出目前test table內的index，可以看出Primary Key本身就會被建立成index</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\">eric_db<span class=\"token operator\">=</span><span class=\"token comment\"># select * from pg_indexes where tablename = 'test';</span>\n schemaname <span class=\"token operator\">|</span> tablename <span class=\"token operator\">|</span>   indexname    <span class=\"token operator\">|</span> <span class=\"token keyword\">tablespace</span> <span class=\"token operator\">|</span>                           indexdef\n\n <span class=\"token keyword\">public</span>     <span class=\"token operator\">|</span> test      <span class=\"token operator\">|</span> test_pkey      <span class=\"token operator\">|</span>            <span class=\"token operator\">|</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">INDEX</span> test_pkey <span class=\"token keyword\">ON</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>test <span class=\"token keyword\">USING</span> <span class=\"token keyword\">btree</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接著我們來討論index與Btree之間的關係</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2722ab193c111ec6dea58cb74a4d20fa/c7dcc/btree-index.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACjUlEQVQoz21T3UvaURg+oZQbawwza60utosxhhuM1j9Q/QHzagljN+2uG/8EIcR1MbapuDGJ7W6MhBBMb5Thd6bOAoP8QMuc8ztFQ38anT3vDy8THl/fc573Oe/7nCNjN3xSqZQ0GAwyr9f7vl6v81KpxM/Pz/nFxQX3+/0fqtUq45xLb6plRqORuVwuRgJbW1tjILJ4PC6hGA6HNbVazVksFn9ms9lfEHRGIpE3tJfL5USOwWAYo1rSsFqtjI0W2eLiIltZWaEzxgCZSqWS7u7uskKhIHJGIszhcLClpSXqTkbc1dVVRtDr9SJH/Nrc3JRgU7K8vDyBOKnVasVxDg8PJRaLZVyj0dxSq9WTOHjc6XSKezqdjuId1MjkcrmENERBFEyfnp7GO51OKp1On3S73QxiZDTyq0qlUoBnx2dnZ8fY+ws79CQIjg81Wfh90m63U9BI7OzsPCDBOfhTA1kA6RKfK+QlEvR4PG8hyOFjJ5/Pd8DhOOQbjZrJZPLIiduFoIBLa8COh+LINpvtfrPZlJtMphm73T4FkWmMRo2M+3w+xdHR0azZbJ7F5Sg3NjbuUg0OuYcGptxutxJdKxqNhgKvgbFQKPQSz0OJZCYQCDwD6cn+/v5tFD9C/gIjPcbNToD3FFEBLsUF8OaA+YODg4VkMjmfSCTk6PI5Q2ccHlnQ1V6r1eIEbKxjPYRRKBdQsAa/OuVy2Yp3+Q/8bTwhNxAFfEAA9R8HgwFngiBwcL8CLlogYJx3/X4/OhwOKb9CJ2vX19c9HLDd6/Vq4P5A/A38AYIAHf6Zj26SY5wv8GovGo1yjMvxUNexHsE4lA/h5+tYLHaJdStQAf87/jEe/I4DcCYQRP4JXvL/t0w0lHeXEcsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2722ab193c111ec6dea58cb74a4d20fa/8ac56/btree-index.webp 240w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/d3be9/btree-index.webp 480w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/de042/btree-index.webp 641w\"\n              sizes=\"(max-width: 641px) 100vw, 641px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2722ab193c111ec6dea58cb74a4d20fa/8ff5a/btree-index.png 240w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/e85cb/btree-index.png 480w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/c7dcc/btree-index.png 641w\"\n            sizes=\"(max-width: 641px) 100vw, 641px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2722ab193c111ec6dea58cb74a4d20fa/c7dcc/btree-index.png\"\n            alt=\"Btree-index\"\n            title=\"Btree-index\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>圖中所有的Key都是test中的id(PK)，而在葉節點的部分才會帶該筆id的資料內容。</p>\n<h3 id=\"query\" style=\"position:relative;\"><a href=\"#query\" aria-label=\"query permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">29</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2a1104dfcaac518ebd53418dbda14426/c7dcc/btree-index-step.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACvklEQVQoz21TS08aURi9BuqjsU1DkVqri3bRhQuSJro3xB9QV5Wk6abu/AXuTAyhSdPYGqW1VPvYmEaTmlShiZBmhmEQEdFErQwooIjADAodDC/j7bnURRe9yck397vnnu9xvyHkatF/4MlmtX5RJD6Oe5FTFJpKpejR0RE9OzujHo/nVTabJZRSLfnfmpiYID+cTrLC84SbniafKSUHU1PXPsD+8vnMWVl2HCeTc9Fo9CsEHX6//yllnIMDDbNWq7XB6/USJzTsdjthkchLq5WQnh4i9vWxDBuAlpzRqN1dXCTxw8M650qELC0tkd7eXpZdM9DQ399PGCwWS53zV3BsTINDjWAyNc0R0vplZEQ7Akdqc1MzZbM1ms3mloGBgRvIptHhcNRLHR0dZbbVZDI163Q6zRg06oI2m60tHo8Hf6tqeF+S9orFYkSSJD879Pl8jzOZzCF6tpNIJHZwdhwMBi1MEBxeVdVoOBzeKxQKYWiE5ufn7zHBDvRHBrkSk6RzrBr2KSbodrufQZDKsqzGYjEVHIog71mpkUgkhv0FuEUIVvBoObTjfr3kbwsLd/fzeV1mfLx9d3bWkFCUtu9oMlYjz/P6ra2t9snJyfZkMmkYHh6+ye4gyC1kedvlchmQtT6Xy+kxDYSIotgjcJxhP52+c8xxxpONje6VUOg6XvaBIAiPUNJDvGwTeN2weo7jmO2CWAfQuba21rW9vd0ZCoV0yNJITk9PKXpkQ2nL+Xye5gsFNnND8IsohcJXwYVB9EtNp9N2RVFOwJ/BCLmAAMADAu6PV6tVSiqVCgX3HeBkDgaUM1QulwO1Wo3tL5DJ4OXlZQkBZkqlkgzuJ9ifwAbgBVjwN/TqJSnKeYteLQcCAbq6ukoxqM/h96Mctq9hVJ6sr6+fw28HMuB/xB/jxncQQGcEL/av0Uv6B1qPPIGt7AHpAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2a1104dfcaac518ebd53418dbda14426/8ac56/btree-index-step.webp 240w,\n/static/2a1104dfcaac518ebd53418dbda14426/d3be9/btree-index-step.webp 480w,\n/static/2a1104dfcaac518ebd53418dbda14426/de042/btree-index-step.webp 641w\"\n              sizes=\"(max-width: 641px) 100vw, 641px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2a1104dfcaac518ebd53418dbda14426/8ff5a/btree-index-step.png 240w,\n/static/2a1104dfcaac518ebd53418dbda14426/e85cb/btree-index-step.png 480w,\n/static/2a1104dfcaac518ebd53418dbda14426/c7dcc/btree-index-step.png 641w\"\n            sizes=\"(max-width: 641px) 100vw, 641px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2a1104dfcaac518ebd53418dbda14426/c7dcc/btree-index-step.png\"\n            alt=\"Steps\"\n            title=\"Steps\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>當我們下Query時，Database找出id為29的方式如圖上所示，且與Btree的走訪方法相同，這邊我就不重複解釋。比較不同的是資料僅存在於葉節點，走訪的過程即便是遇到Key相同只要不在葉節點就無法取得資料。</p>\n<h3 id=\"那假設我們是找num--29的時候也是照著btree的方法\" style=\"position:relative;\"><a href=\"#%E9%82%A3%E5%81%87%E8%A8%AD%E6%88%91%E5%80%91%E6%98%AF%E6%89%BEnum--29%E7%9A%84%E6%99%82%E5%80%99%E4%B9%9F%E6%98%AF%E7%85%A7%E8%91%97btree%E7%9A%84%E6%96%B9%E6%B3%95\" aria-label=\"那假設我們是找num  29的時候也是照著btree的方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>那假設我們是找num = 29的時候也是照著Btree的方法?</h3>\n<p>答案是否定的，只要沒設index，Database就會用full scan的方式去搜尋。</p>\n<h2 id=\"原理\" style=\"position:relative;\"><a href=\"#%E5%8E%9F%E7%90%86\" aria-label=\"原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原理</h2>\n<p>每當我們建立index時，Database都會幫我們建立一個index table去維護這個Btree，所以index越多則index table當然也越來越多，所需要的空間需求也會隨之增加。</p>\n<p>當我們建立Primary Key以外的index時，基本上原理都是相同的，差別只在於非PK的Btree葉節點的資料內容為PK。</p>\n<p>接著上面的範例，我們設了num為index，然後找出num = 29，Database動作如下</p>\n<ul>\n<li>透過num的btree找出id</li>\n<li>再由id的btree找出整個row的內容</li>\n</ul>\n<h3 id=\"我的硬碟就是大那我每個欄位都設index來加速好了\" style=\"position:relative;\"><a href=\"#%E6%88%91%E7%9A%84%E7%A1%AC%E7%A2%9F%E5%B0%B1%E6%98%AF%E5%A4%A7%E9%82%A3%E6%88%91%E6%AF%8F%E5%80%8B%E6%AC%84%E4%BD%8D%E9%83%BD%E8%A8%ADindex%E4%BE%86%E5%8A%A0%E9%80%9F%E5%A5%BD%E4%BA%86\" aria-label=\"我的硬碟就是大那我每個欄位都設index來加速好了 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>我的硬碟就是大，那我每個欄位都設index來加速好了</h3>\n<p>上面有提到Database會幫我們維護所有的index btree，若index太多會造成新增或刪除資料的時候負擔太大，同時維護多個Btree(包括這些index table的讀寫動作)所造成的負擔都會使你的系統效能變差。</p>\n<h2 id=\"實驗\" style=\"position:relative;\"><a href=\"#%E5%AF%A6%E9%A9%97\" aria-label=\"實驗 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>實驗</h2>\n<p>隨機建立100萬份資料</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> test<span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">integer</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span><span class=\"token punctuation\">,</span>\n    num <span class=\"token keyword\">integer</span><span class=\"token punctuation\">,</span>\n    content <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> test_num_index <span class=\"token keyword\">on</span> test<span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> test <span class=\"token keyword\">SELECT</span> generate_series<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> id<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token operator\">^</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>::<span class=\"token keyword\">integer</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token operator\">^</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>::<span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>若沒有postgres的環境的話，可以用docker-compose來玩，這邊是我實驗的環境</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-docker line-numbers\"><code class=\"language-docker\">version: \"3.3\"\nservices:\n  postgres:\n    image: postgres:latest\n    container_name: eric_db\n    ports:\n      - 5432:5432\n    environment: \n      POSTGRES_DB: eric_db\n      POSTGRES_USER: eric\n      POSTGRES_PASSWORD: eric\n    volumes:\n      - ./init.sql:/docker-entrypoint-initdb.d/init.sql\n  </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>explain是postgres提供出來查詢sql command的成本，我們就用此方法來實驗</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\">eric_db<span class=\"token operator\">=</span><span class=\"token comment\"># explain select * from test where content = '29';</span>\n                               QUERY <span class=\"token keyword\">PLAN</span>\n Gather  <span class=\"token punctuation\">(</span>cost<span class=\"token operator\">=</span><span class=\"token number\">1000.00</span><span class=\"token punctuation\">.</span><span class=\"token number\">.13561</span><span class=\"token number\">.43</span> <span class=\"token keyword\">rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> width<span class=\"token operator\">=</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span>\n   Workers Planned: <span class=\"token number\">2</span>\n   <span class=\"token operator\">-</span><span class=\"token operator\">></span>  Parallel Seq Scan <span class=\"token keyword\">on</span> test  <span class=\"token punctuation\">(</span>cost<span class=\"token operator\">=</span><span class=\"token number\">0.00</span><span class=\"token punctuation\">.</span><span class=\"token number\">.12561</span><span class=\"token number\">.33</span> <span class=\"token keyword\">rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> width<span class=\"token operator\">=</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span>\n         Filter: <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span>::<span class=\"token keyword\">text</span> <span class=\"token operator\">=</span> <span class=\"token string\">'29'</span>::<span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token keyword\">rows</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\">eric_db<span class=\"token operator\">=</span><span class=\"token comment\"># explain select * from test where id = 29;</span>\n                              QUERY <span class=\"token keyword\">PLAN</span>\n\n <span class=\"token keyword\">Index</span> Scan <span class=\"token keyword\">using</span> test_pkey <span class=\"token keyword\">on</span> test  <span class=\"token punctuation\">(</span>cost<span class=\"token operator\">=</span><span class=\"token number\">0.42</span><span class=\"token punctuation\">.</span><span class=\"token number\">.8</span><span class=\"token number\">.44</span> <span class=\"token keyword\">rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> width<span class=\"token operator\">=</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">Index</span> Cond: <span class=\"token punctuation\">(</span>id <span class=\"token operator\">=</span> <span class=\"token number\">29</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token keyword\">rows</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>若未使用index的情況下成本為13561.43，這邊Postgres已經幫我們使用了並行處裡，否則成本會更高。反觀使用index的總成本只需要8.44</p>\n<p>這邊我就不解釋此成本的計算方式，簡單理解成數值越高成本越大即可，有興趣者可前往postgres的document。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>index是非常典型的以空間換取時間的例子，但也不是index越多越好，而是必須透過實際情況來決定哪些column該設定index，都沒用到的column設定index也是很浪費的。</p>","fields":{"slug":"/posts/database-index","tagSlugs":["/tag/database/"],"readingTime":{"text":"7 min read"}},"frontmatter":{"date":"2020-11-11T20:15:00.000Z","description":"簡單理解Database index","tags":["Database"],"title":"Database Index","socialImage":""}}},"pageContext":{"slug":"/posts/database-index"}},"staticQueryHashes":["251939775","3688386433","401334301"]}