{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/database-index","result":{"data":{"markdownRemark":{"id":"2cfcc7e5-4767-56d8-bb55-1a1501129af2","html":"<h2 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>此文章的目的並非讓大家對於Btree有深度了解，而是使用簡單的方式解釋Database Index的基本原理，使得在設計Index的時候有正確的方向。</p>\n<h2 id=\"介紹\" style=\"position:relative;\"><a href=\"#%E4%BB%8B%E7%B4%B9\" aria-label=\"介紹 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>介紹</h2>\n<p>當我們發現資料庫Query速度越來越慢，且已經漸漸地影響到使用者體驗的時候，那就是優化資料庫的最佳時機，而最典型的方法就是加index，但是在設計上如果不理解index的原理而隨便亂加的話，反而會造成整體資料庫效率降低!!</p>\n<p>目前多數的RDBMS的index都是由Btree的方法實作，所以講Database index之前，必須先簡單了解一下Btree的基本特性。</p>\n<h2 id=\"btree\" style=\"position:relative;\"><a href=\"#btree\" aria-label=\"btree permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Btree</h2>\n<p>這是Btree的基本樣貌:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 581px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b0d23b6403235a016886f015fa36c24/92d15/btree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABXElEQVQoz51STWvCQBCNK3gQ8dhecujBhjaHWrzlF5X+Gg+FUijof7DUY9BDCAGpGiJJ8POgEolCJG1Jidntm+KtpZQOLDuz8/bN7JuVpB/M9/087cPh8FnAgiDIFosFJ99xHLvZbBYo32q1ctJfDPcY7YZhPHHOxWq1eptMJu/k93q9F03Tykfc98sAsv1+zwBkAOTm8zmrVCpFpPLT6fQM3V53u92arus1xFUsRZblQqlUKtbr9TyRmqbJ4jhmo9GI/dal9C/bbDYKrdlsdtlut6vr9VpFxyeUg3+62+1UdKlalnW13W4vcKY0Gg0qWIYUaqfTqQ4GAzWKonO8TpE8zxNpmgqILsIwFKQTnvBIhCC5PxwOAkQC4K+c67qvSDHoe5tlmQBRNh6PBeFs2xYSNKHpcVTj6CylSaLiw3HKdxRDn3S5XGbkgzhisH6/f0NxkiQfxx/AUYx/AnLcHK81m6ngAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/3b0d23b6403235a016886f015fa36c24/8ac56/btree.webp 240w,\n/static/3b0d23b6403235a016886f015fa36c24/d3be9/btree.webp 480w,\n/static/3b0d23b6403235a016886f015fa36c24/39daa/btree.webp 581w\"\n          sizes=\"(max-width: 581px) 100vw, 581px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/3b0d23b6403235a016886f015fa36c24/8ff5a/btree.png 240w,\n/static/3b0d23b6403235a016886f015fa36c24/e85cb/btree.png 480w,\n/static/3b0d23b6403235a016886f015fa36c24/92d15/btree.png 581w\"\n          sizes=\"(max-width: 581px) 100vw, 581px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/3b0d23b6403235a016886f015fa36c24/92d15/btree.png\"\n          alt=\"Btree\"\n          title=\"Btree\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>Btree共有幾種特性:</p>\n<ul>\n<li>有別於一般二元樹，每個node都能擁有多個Key</li>\n<li>一個node可以擁有K+1個支線(K = Key的數量)</li>\n<li>Key數值必在兩個Parent的Key範圍內(如圖上的56/74都在47及99內)</li>\n<li>Btree為平衡樹且每個葉節點深度必定相同</li>\n</ul>\n<p>接著我們來看一下Search速度上的差異，圖上的例子共有23/44/47等八個數字，若我們用For-loop的方式尋找，最差情況是O(n)</p>\n<p>若我們從Btree的方式搜尋，則最差情況是最深階層數，故為O(log n)</p>\n<h2 id=\"database-index\" style=\"position:relative;\"><a href=\"#database-index\" aria-label=\"database index permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Database index</h2>\n<p>其實在使用資料庫的同時，我們已經不知不覺中使用了大量的index，而這個index就是每個Table的Primary Key，接下來我們就用PK來解釋Database的搜尋方式</p>\n<p>首先我們先建立簡單的Table</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> test<span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">integer</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span><span class=\"token punctuation\">,</span>\n    num <span class=\"token keyword\">integer</span><span class=\"token punctuation\">,</span>\n    content <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>找出目前test table內的index，可以看出Primary Key本身就會被建立成index</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\">eric_db<span class=\"token operator\">=</span><span class=\"token comment\"># select * from pg_indexes where tablename = 'test';</span>\n schemaname <span class=\"token operator\">|</span> tablename <span class=\"token operator\">|</span>   indexname    <span class=\"token operator\">|</span> <span class=\"token keyword\">tablespace</span> <span class=\"token operator\">|</span>                           indexdef\n\n <span class=\"token keyword\">public</span>     <span class=\"token operator\">|</span> test      <span class=\"token operator\">|</span> test_pkey      <span class=\"token operator\">|</span>            <span class=\"token operator\">|</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">INDEX</span> test_pkey <span class=\"token keyword\">ON</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>test <span class=\"token keyword\">USING</span> <span class=\"token keyword\">btree</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接著我們來討論index與Btree之間的關係</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2722ab193c111ec6dea58cb74a4d20fa/c7dcc/btree-index.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACKUlEQVQoz61TS29SURA+rRf72qg/wKa/oH/ABdHEytV1F66UxA1s69o0hC6JGEmDD9QmFm6MYUcIiTSBNEChvOQh74fAhYA8JIAhIcdviCYu7tJJJjPnfPPNnfOdcxlTsEgkIlAMBoNGDmu327zValHKQ6HQEWHD4VBQ4jKLxcJcLhdLp9NMr9czcMivEObz+Q5+wJrN5rdqtZpDk57f739KGGpWqVan0y251MNqtTIWCAT+guQrFNVq9SY4KuQCmm263e4tg8FwbTabbWBPRRjV/Mshz2Qy7P+b3W6/XqvVjgeDgS2bzb7HCU+KxeJzwqLR6C1Zlj9CvzeVSuUtjmxPJBKPAK2gxtTr9U7Aedfv922QxOJ0Om8ws9m8TaKTdbvdZUQxp4Zer1dH68ViwUej0RKDRBKg1Xw+v6A1mi73O50OdzgcOwzarMXjcQ0muxsOh0V8SdNoNG5TQ0mSbmL6+6VSaS8Wi4kgix6PZ5cwaKtGkz1MqEF+D/mdVCp1lYmiuKUkBQrpWawrQIJWq1UpcUwmk8BwTMgkH8Jt9EKgRwVT7mOaz1h/xzqbTCYfQL8MJjFikhBqjcBP4U74J/SQsPcMr0CmJ0P6vIJ/4X8Mmj6ZTqdfKZ/P5zyXyz0kHeniJpPJT9R+ADmAmgTiJeIF9o6pnpGohULhJUguupR6vU4NHpfL5TAJjdv9hT9mH7pOcRFWXFgH/hr5GeIF/By5H5wX4/GY/wbji/cJfNiGVQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/2722ab193c111ec6dea58cb74a4d20fa/8ac56/btree-index.webp 240w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/d3be9/btree-index.webp 480w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/de042/btree-index.webp 641w\"\n          sizes=\"(max-width: 641px) 100vw, 641px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/2722ab193c111ec6dea58cb74a4d20fa/8ff5a/btree-index.png 240w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/e85cb/btree-index.png 480w,\n/static/2722ab193c111ec6dea58cb74a4d20fa/c7dcc/btree-index.png 641w\"\n          sizes=\"(max-width: 641px) 100vw, 641px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/2722ab193c111ec6dea58cb74a4d20fa/c7dcc/btree-index.png\"\n          alt=\"Btree-index\"\n          title=\"Btree-index\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>圖中所有的Key都是test中的id(PK)，而在葉節點的部分才會帶該筆id的資料內容。</p>\n<h3 id=\"query\" style=\"position:relative;\"><a href=\"#query\" aria-label=\"query permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test <span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span> <span class=\"token number\">29</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2a1104dfcaac518ebd53418dbda14426/c7dcc/btree-index-step.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACT0lEQVQoz61SS29SURA+bcFH60L9ARp/gbuuXGBMrL113YUrJXGDW111YQzBJRErafCBtYkCMYYdIomYlBgeFeHyuvJ+CFwQ7gUkgCHi9RsCrlg6yeTMOd/Md+Z8Zxib2R+4MvOv8biKzkKBgEGBNRoNpV6vU6gEg8GHhHW7XRVbZGazmbldLvY+GmXhnR12tLvLvkjSCmH84eFdCVar1b6VSqU0SNo+n+8eYeBehjOdTseSySRzgcNisTDm9/vnIPmSUq2uKOvrp34zpsZeBbLVD273ml6vPz0ajU7iTA0+tUajWf1XM6tPpVLs/5vNZjtTLpf35E7HWhCE/a4kHWRyuUeEhcPhS6IovoZ+z4vF4gs82cbz/E1AS7lczthutw8EQXgpy7IVkpidTudZZjKZzpPoZHKrNV2RTH/DvF6vjvaTyUTp9XpTDBI5AC1nMpkJ7UE6PW82m4rdbr/AoM1xPhrd/CFJV+uh0JaYz3OVWu0yETocjnPofiufz29EIhEOxZzH47lIGLTVgGQDHW4ivob4SiKROMY4jlubP/8OnjKPszxPY3FigUoqrVarXiSf0WhUsVarBZnEB3CrjAnpdDoF6LGNbt5hYr5DHyEWi12Hfil0YkAnQeQagL+BO+FvweHA2X1MgUgjQ/o8hX9UZgZNbw+HwzjF4/FYSafTN0hHXGYdDAY/kfsKxX7k8FjDWEM426N8RqJms9knKHLhJqVSqRDBrUKhcERC43d/BQKB7Wq1OsRHWPBhTfgzxJ+whuCfEftQ87jf7yt/ARSt+xszVQORAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/2a1104dfcaac518ebd53418dbda14426/8ac56/btree-index-step.webp 240w,\n/static/2a1104dfcaac518ebd53418dbda14426/d3be9/btree-index-step.webp 480w,\n/static/2a1104dfcaac518ebd53418dbda14426/de042/btree-index-step.webp 641w\"\n          sizes=\"(max-width: 641px) 100vw, 641px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/2a1104dfcaac518ebd53418dbda14426/8ff5a/btree-index-step.png 240w,\n/static/2a1104dfcaac518ebd53418dbda14426/e85cb/btree-index-step.png 480w,\n/static/2a1104dfcaac518ebd53418dbda14426/c7dcc/btree-index-step.png 641w\"\n          sizes=\"(max-width: 641px) 100vw, 641px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/2a1104dfcaac518ebd53418dbda14426/c7dcc/btree-index-step.png\"\n          alt=\"Steps\"\n          title=\"Steps\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>當我們下Query時，Database找出id為29的方式如圖上所示，且與Btree的走訪方法相同，這邊我就不重複解釋。比較不同的是資料僅存在於葉節點，走訪的過程即便是遇到Key相同只要不在葉節點就無法取得資料。</p>\n<h3 id=\"那假設我們是找num--29的時候也是照著btree的方法\" style=\"position:relative;\"><a href=\"#%E9%82%A3%E5%81%87%E8%A8%AD%E6%88%91%E5%80%91%E6%98%AF%E6%89%BEnum--29%E7%9A%84%E6%99%82%E5%80%99%E4%B9%9F%E6%98%AF%E7%85%A7%E8%91%97btree%E7%9A%84%E6%96%B9%E6%B3%95\" aria-label=\"那假設我們是找num  29的時候也是照著btree的方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>那假設我們是找num = 29的時候也是照著Btree的方法?</h3>\n<p>答案是否定的，只要沒設index，Database就會用full scan的方式去搜尋。</p>\n<h2 id=\"原理\" style=\"position:relative;\"><a href=\"#%E5%8E%9F%E7%90%86\" aria-label=\"原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原理</h2>\n<p>每當我們建立index時，Database都會幫我們建立一個index table去維護這個Btree，所以index越多則index table當然也越來越多，所需要的空間需求也會隨之增加。</p>\n<p>當我們建立Primary Key以外的index時，基本上原理都是相同的，差別只在於非PK的Btree葉節點的資料內容為PK。</p>\n<p>接著上面的範例，我們設了num為index，然後找出num = 29，Database動作如下</p>\n<ul>\n<li>透過num的btree找出id</li>\n<li>再由id的btree找出整個row的內容</li>\n</ul>\n<h3 id=\"我的硬碟就是大，那我每個欄位都設index來加速好了\" style=\"position:relative;\"><a href=\"#%E6%88%91%E7%9A%84%E7%A1%AC%E7%A2%9F%E5%B0%B1%E6%98%AF%E5%A4%A7%EF%BC%8C%E9%82%A3%E6%88%91%E6%AF%8F%E5%80%8B%E6%AC%84%E4%BD%8D%E9%83%BD%E8%A8%ADindex%E4%BE%86%E5%8A%A0%E9%80%9F%E5%A5%BD%E4%BA%86\" aria-label=\"我的硬碟就是大，那我每個欄位都設index來加速好了 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>我的硬碟就是大，那我每個欄位都設index來加速好了</h3>\n<p>上面有提到Database會幫我們維護所有的index btree，若index太多會造成新增或刪除資料的時候負擔太大，同時維護多個Btree(包括這些index table的讀寫動作)所造成的負擔都會使你的系統效能變差。</p>\n<h2 id=\"實驗\" style=\"position:relative;\"><a href=\"#%E5%AF%A6%E9%A9%97\" aria-label=\"實驗 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>實驗</h2>\n<p>隨機建立100萬份資料</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> test<span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">integer</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span><span class=\"token punctuation\">,</span>\n    num <span class=\"token keyword\">integer</span><span class=\"token punctuation\">,</span>\n    content <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> test_num_index <span class=\"token keyword\">on</span> test<span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> test <span class=\"token keyword\">SELECT</span> generate_series<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> id<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token operator\">^</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>::<span class=\"token keyword\">integer</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token operator\">^</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>::<span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>若沒有postgres的環境的話，可以用docker-compose來玩，這邊是我實驗的環境</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-docker line-numbers\"><code class=\"language-docker\">version<span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.3\"</span>\nservices<span class=\"token punctuation\">:</span>\n  postgres<span class=\"token punctuation\">:</span>\n    image<span class=\"token punctuation\">:</span> postgres<span class=\"token punctuation\">:</span>latest\n    container_name<span class=\"token punctuation\">:</span> eric_db\n    ports<span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 5432<span class=\"token punctuation\">:</span>5432\n    environment<span class=\"token punctuation\">:</span> \n      POSTGRES_DB<span class=\"token punctuation\">:</span> eric_db\n      POSTGRES_USER<span class=\"token punctuation\">:</span> eric\n      POSTGRES_PASSWORD<span class=\"token punctuation\">:</span> eric\n    volumes<span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./init.sql<span class=\"token punctuation\">:</span>/docker<span class=\"token punctuation\">-</span>entrypoint<span class=\"token punctuation\">-</span>initdb.d/init.sql\n  </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>explain是postgres提供出來查詢sql command的成本，我們就用此方法來實驗</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\">eric_db<span class=\"token operator\">=</span><span class=\"token comment\"># explain select * from test where content = '29';</span>\n                               QUERY <span class=\"token keyword\">PLAN</span>\n Gather  <span class=\"token punctuation\">(</span>cost<span class=\"token operator\">=</span><span class=\"token number\">1000.00</span><span class=\"token punctuation\">.</span><span class=\"token number\">.13561</span><span class=\"token number\">.43</span> <span class=\"token keyword\">rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> width<span class=\"token operator\">=</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span>\n   Workers Planned: <span class=\"token number\">2</span>\n   <span class=\"token operator\">-</span><span class=\"token operator\">></span>  Parallel Seq Scan <span class=\"token keyword\">on</span> test  <span class=\"token punctuation\">(</span>cost<span class=\"token operator\">=</span><span class=\"token number\">0.00</span><span class=\"token punctuation\">.</span><span class=\"token number\">.12561</span><span class=\"token number\">.33</span> <span class=\"token keyword\">rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> width<span class=\"token operator\">=</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span>\n         Filter: <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span>::<span class=\"token keyword\">text</span> <span class=\"token operator\">=</span> <span class=\"token string\">'29'</span>::<span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token keyword\">rows</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sql line-numbers\"><code class=\"language-sql\">eric_db<span class=\"token operator\">=</span><span class=\"token comment\"># explain select * from test where id = 29;</span>\n                              QUERY <span class=\"token keyword\">PLAN</span>\n\n <span class=\"token keyword\">Index</span> Scan <span class=\"token keyword\">using</span> test_pkey <span class=\"token keyword\">on</span> test  <span class=\"token punctuation\">(</span>cost<span class=\"token operator\">=</span><span class=\"token number\">0.42</span><span class=\"token punctuation\">.</span><span class=\"token number\">.8</span><span class=\"token number\">.44</span> <span class=\"token keyword\">rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> width<span class=\"token operator\">=</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">Index</span> Cond: <span class=\"token punctuation\">(</span>id <span class=\"token operator\">=</span> <span class=\"token number\">29</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token keyword\">rows</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>若未使用index的情況下成本為13561.43，這邊Postgres已經幫我們使用了並行處裡，否則成本會更高。反觀使用index的總成本只需要8.44</p>\n<p>這邊我就不解釋此成本的計算方式，簡單理解成數值越高成本越大即可，有興趣者可前往postgres的document。</p>\n<h2 id=\"結論\" style=\"position:relative;\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-label=\"結論 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>index是非常典型的以空間換取時間的例子，但也不是index越多越好，而是必須透過實際情況來決定哪些column該設定index，都沒用到的column設定index也是很浪費的。</p>","fields":{"slug":"/posts/database-index","tagSlugs":["/tag/database/"]},"frontmatter":{"date":"2020-11-11T20:15:00.000Z","description":"簡單理解Database index","tags":["Database"],"title":"Database Index","socialImage":""}}},"pageContext":{"slug":"/posts/database-index"}},"staticQueryHashes":["251939775","3688386433","401334301"]}